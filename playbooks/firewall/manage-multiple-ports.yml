---
- name: Manage Multiple Firewall Ports (AAP Survey Version)
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Install UFW (Ubuntu)
      apt:
        name: ufw
        state: present
        update_cache: yes
      when: ansible_distribution == "Ubuntu"

    - name: Convert port list to array
      set_fact:
        port_array: "{{ port_list.split(',') | map('trim') | list }}"
      when: port_list is defined and port_list != ""

    - name: Add multiple firewall rules
      ufw:
        rule: "{{ rule_action }}"
        port: "{{ item }}"
        proto: "{{ protocol }}"
        comment: "Bulk rule for {{ item }}/{{ protocol }}"
      loop: "{{ port_array }}"
      when: 
        - ansible_distribution == "Ubuntu"
        - action == "add"
        - port_array is defined

    - name: Remove multiple firewall rules
      ufw:
        rule: "{{ rule_action }}"
        port: "{{ item }}"
        proto: "{{ protocol }}"
        delete: yes
      loop: "{{ port_array }}"
      when: 
        - ansible_distribution == "Ubuntu"
        - action == "remove"
        - port_array is defined

    - name: Display processed ports
      debug:
        msg: |
          Action: {{ action }}
          Ports processed: {{ port_array | join(', ') }}
          Protocol: {{ protocol }}
          Rule Action: {{ rule_action }}
      when: port_array is defined